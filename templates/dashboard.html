<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PiTemplar Control</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: system-ui, sans-serif;
    background:
        linear-gradient(rgba(0,0,0,0.75), rgba(0,0,0,0.75)),
        url("/static/castle.png") no-repeat center center fixed;
    background-size: cover;
    color: #eee;
    padding: 20px;
}

.status-knight-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.card {
    background: rgba(20,20,20,0.9);
    padding: 22px;
    border-radius: 10px;
    max-width: 520px;
    box-shadow: 0 0 18px rgba(0,0,0,0.7);
}

h2, h3 {
    font-family: 'Cinzel', serif;
    color: #f0e6c8;
}

.stat-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Cinzel', serif;
}

.gauge {
    background: #333;
    border-radius: 14px;
    overflow: hidden;
    margin: 6px 0 14px;
}

.gauge-inner {
    height: 30px;
    line-height: 30px;
    padding-right: 10px;
    text-align: right;
    font-weight: bold;
    color: #fff;
    border-radius: 14px;
    transition: width 0.6s;
}

button, input, select {
    width: 100%;
    margin-top: 6px;
    padding: 8px;
    border-radius: 6px;
    border: none;
    background: #333;
    color: #eee;
}

button:hover { background:#444; }

.knight-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.speech-bubble {
    background: #222;
    padding: 12px;
    border-radius: 12px;
    max-width: 280px;
    font-family: 'Cinzel', serif;
    margin-bottom: 6px;
}

.knight-img { width: 120px; }

.controls-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 20px;
}
</style>
</head>

<body>

<div class="status-knight-container">
    <div class="card">
        <h2>Thy system, my liege</h2>
        <p><b>IP:</b> {{ ip }}</p>

        <div class="stat-label">‚öîÔ∏è CPU {{ cpu }}%</div>
        <div class="gauge"><div class="gauge-inner" style="width:{{ cpu }}%;background:#c0392b">{{ cpu }}%</div></div>

        <div class="stat-label">üõ°Ô∏è Disk {{ disk.used_percent }}%</div>
        <div class="gauge"><div class="gauge-inner" style="width:{{ disk.used_percent }}%;background:#e67e22">{{ disk.used_percent }}%</div></div>

        <div class="stat-label">üìú RAM {{ ram }}%</div>
        <div class="gauge"><div class="gauge-inner" style="width:{{ ram }}%;background:#8e44ad">{{ ram }}%</div></div>

        <div class="stat-label">üë• Sires {{ users }}</div>
        <div class="gauge"><div class="gauge-inner" style="width:{{ users }}%;background:#27ae60">{{ users }}</div></div>
    </div>

    <div class="knight-container">
        <div class="speech-bubble">
            Sire, Login to thy share! 
            I shall keep thy data safe at 
            \\Templar\private
        </div>
        <img src="/static/knight.png" class="knight-img">
    </div>
</div>

<div class="controls-section">

    <div class="card">
        <h3>Your will, Sire</h3>
        <button onclick="post('/api/rotate')">Rotate Screen</button>
        <button onclick="post('/api/invert')">Invert Screen</button>
        <button onclick="rebootSystem()">Reboot System</button>
    </div>

    <div class="card">
        <h3>Change thy secret phrase</h3>
        <input type="password" id="oldpw" placeholder="Current password">
        <input type="password" id="newpw" placeholder="New password">
        <button onclick="changePassword()">Change Password</button>
        <p id="pwstatus"></p>
    </div>

    <div class="card">
        <h3>Conquer a new castle</h3>

        <select id="scannedNetworks">
            <option disabled selected>Rescan to see networks...</option>
        </select>
        <button onclick="scanNetworks()">Rescan Networks</button>

        <p style="text-align:center; margin:6px 0;">Input thy new castle from the list Sire!</p>

        <input type="text" id="ssid" placeholder="SSID">
        <input type="password" id="netpw" placeholder="Password">
        <button onclick="switchNetwork()">Connect</button>

        <p id="netstatus"></p>
    </div>

</div>

<script>
function post(url) { fetch(url, { method: "POST" }); }

async function rebootSystem() {
    if (!confirm("Reboot the system, my liege?")) return;
    await fetch("/api/reboot", { method: "POST" });
    alert("The realm shall fall... and rise anew.");
}

async function changePassword() {
    const r = await fetch("/api/change_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ old: oldpw.value, new: newpw.value })
    });
    pwstatus.textContent = r.ok ? "Password updated" : "Failed";
}

async function switchNetwork() {
    const r = await fetch("/api/switch_network", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ssid: ssid.value, password: netpw.value })
    });
    const d = await r.json();
    netstatus.textContent = d.ok ? d.message : d.error;
}

async function scanNetworks() {
    scannedNetworks.innerHTML = "<option>Scanning...</option>";
    try {
        const r = await fetch("/api/scan_networks");
        const nets = await r.json();
        scannedNetworks.innerHTML = "";
        for (const n of nets) {
            const o = document.createElement("option");
            o.value = n.ssid;
            o.textContent = `${n.ssid} ${n.secure ? "üîí" : ""} (${n.signal}%)`;
            scannedNetworks.appendChild(o);
        }
    } catch(e) {
        scannedNetworks.innerHTML = "<option>Error scanning networks</option>";
    }
}

scannedNetworks.addEventListener("change", () => {
    ssid.value = scannedNetworks.value;
});

scanNetworks();
</script>

</body>
</html>